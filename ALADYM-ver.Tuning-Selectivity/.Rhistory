}
# extraction function of saved data for global plot
extract_combo_outputs <- function(combo_name, base_dir) {
folder <- file.path(base_dir, combo_name)
message("Reading combo: ", combo_name)
message("Folder: ", folder)
ssb_file   <- file.path(folder, "SSB_annual.csv")
fbar_file  <- file.path(folder, "annual_F.csv")
catch_file <- file.path(folder, "total_catch_sim.csv")
ssb   <- read.csv(ssb_file, sep=";", header=TRUE)
fbar  <- read.csv(fbar_file, sep=";", header=TRUE)
catch <- read.csv(catch_file, sep=";", header=TRUE)
# put everything into long format with combo name
df <- data.frame(
Year = ssb$Year,      # assuming same years everywhere
SSB  = ssb$SSB,
Fbar = fbar$F,
Catch = catch$Total,
Combo = combo_name,
stringsAsFactors = FALSE
)
return(df)
}
read_fleet_catch <- function(combo_name, base_dir) {
folder <- file.path(base_dir, combo_name)
sim_file <- file.path(folder, "sim_fleet_catch.csv")
obs_file <- file.path(folder, "obs_fleet_catch.csv")
sim <- read.csv(sim_file, sep=";", header=TRUE, check.names=FALSE)
obs <- read.csv(obs_file, sep=";", header=TRUE, check.names=FALSE)
return(list(sim = sim, obs = obs))
}
fleet_to_long <- function(df, years) {
stopifnot(nrow(df) == length(years))
gears <- colnames(df)
out <- data.frame(
Year  = rep(years, times = length(gears)),
Gear  = rep(gears, each = length(years)),
Value = as.numeric(unlist(df)),
stringsAsFactors = FALSE
)
return(out)
}
plot_gear_sim_vs_obs <- function(sim_long, obs_long, gear_name, combo_name, out_dir) {
sim_g <- subset(sim_long, Gear == gear_name)
obs_g <- subset(obs_long, Gear == gear_name)
p <- ggplot() +
geom_line(
data = sim_g,
aes(x = Year, y = Value, color = "Simulation"),
linewidth = 1.2
) +
geom_point(
data = obs_g,
aes(x = Year, y = Value, color = "Observed"),
size = 2
) +
scale_color_manual(
values = c("Simulation" = "black", "Observed" = "blue")
) +
theme_bw() +
ggtitle(paste("Sim vs Obs catch –", gear_name, "\nCombo:", combo_name)) +
xlab("Year") +
ylab("Catch") +
labs(color = "")
outfile <- file.path(
out_dir,
paste0("Fleet_", gear_name, "_sim_vs_obs.jpeg")
)
ggsave(outfile, p, width = 9, height = 4.5, dpi = 300)
}
read_fleet_obs <- function(base_dir, years) {
obs_file <- file.path(base_dir, "obs_fleet_catch.csv")
obs <- read.csv(obs_file, sep=";", header=TRUE, check.names=FALSE)
stopifnot(nrow(obs) == length(years))
obs_long <- data.frame(
Year  = rep(years, times = ncol(obs)),
Gear  = rep(colnames(obs), each = length(years)),
Value = as.numeric(unlist(obs)),
stringsAsFactors = FALSE
)
return(obs_long)
}
extract_all_fleet_sims <- function(combo_names, base_dir, years) {
all_sim <- lapply(combo_names, function(cb) {
folder <- file.path(base_dir, cb)
sim_file <- file.path(folder, "sim_fleet_catch.csv")
sim <- read.csv(sim_file, sep=";", header=TRUE, check.names=FALSE)
sim_long <- data.frame(
Year  = rep(years, times = ncol(sim)),
Gear  = rep(colnames(sim), each = length(years)),
Value = as.numeric(unlist(sim)),
Combo = cb,
stringsAsFactors = FALSE
)
sim_long
})
do.call(rbind, all_sim)
}
plot_gear_all_combos <- function(sim_long, obs_long, gear_name, out_dir) {
sim_g <- subset(sim_long, Gear == gear_name)
obs_g <- subset(obs_long, Gear == gear_name)
p <- ggplot() +
geom_line(data = sim_g,
aes(x = Year, y = Value, group = Combo, color = Combo),
alpha = 0.3,
linewidth = 0.8,
show.legend = FALSE) +
geom_line(
data = sim_g[1, ],
aes(x = Year, y = Value, color = "Simulation"),
linewidth = 0.8
) +
geom_point(
data = obs_g,
aes(x = Year, y = Value, color = "Observation"),
inherit.aes = FALSE,
size = 2
) +
scale_color_manual(
values = c(
"Simulation" = "black",
"Observation"   = "blue"
)
) +
theme_bw() +
ggtitle(paste("Fleet ", gear_name, "Sim vs Obs")) +
xlab("Year") +
ylab("Catch") +
labs(color = "")
ggsave(
filename = file.path(out_dir, paste0("Fleet_", gear_name, "_all_combos.jpeg")),
plot = p,
width = 10,
height = 5,
dpi = 300
)
}
plot_all_gears_all_combos <- function(combo_names, base_dir, years, output_dir) {
folder <- file.path(base_dir, output_dir)
sim_long <- extract_all_fleet_sims(combo_names, base_dir, years)
obs_long <- read_fleet_obs(base_dir, years)
gears <- unique(sim_long$Gear)
for (g in gears) {
plot_gear_all_combos(
sim_long = sim_long,
obs_long = obs_long,
gear_name = g,
out_dir = folder
)
}
}
plot_all_gears_for_combo <- function(combo_name, base_dir, output_dir, years) {
message("Plotting fleet diagnostics for combo: ", combo_name)
folder <- file.path(base_dir, output_dir, combo_name)
if (!dir.exists(folder)) {
dir.create(folder, recursive = TRUE)
}
fleet <- read_fleet_catch(combo_name, base_dir)
sim_long <- fleet_to_long(fleet$sim, years)
obs_long <- fleet_to_long(fleet$obs, years)
gears <- colnames(fleet$sim)
for (g in gears) {
plot_gear_sim_vs_obs(
sim_long = sim_long,
obs_long = obs_long,
gear_name = g,
combo_name = combo_name,
out_dir = folder
)
}
}
plot_multi_gear_all_combos <- function(sim_long, obs_long, gears_subset, out_dir, page_id) {
sim_p <- subset(sim_long, Gear %in% gears_subset)
obs_p <- subset(obs_long, Gear %in% gears_subset)
p <- ggplot() +
geom_line(
data = sim_p,
aes(x = Year, y = Value, group = Combo, color = Combo),
alpha = 0.3,
linewidth = 0.7,
show.legend = FALSE
) +
geom_line(
data = sim_p[sim_p$Combo == sim_p$Combo[1], ],
aes(x = Year, y = Value, color = "Simulation"),
linewidth = 0.7,
alpha = 0.3
) +
geom_point(
data = obs_p,
aes(x = Year, y = Value, color = "Observation"),
size = 2
) +
scale_color_manual(
values = c(
"Simulation"  = "black",
"Observation" = "blue"
)
) +
facet_wrap(~ Gear, ncol = 3, scales = "free_y") +
theme_bw() +
labs(
title = paste("Fleet catch – all combinations (page", page_id, ")"),
x = "Year",
y = "Catch",
color = ""
)
ggsave(
filename = file.path(
out_dir,
paste0("Fleet_all_combos_page_", page_id, ".jpeg")
),
plot = p,
width = 12,
height = 10,
dpi = 300
)
}
split_into_pages <- function(x, page_size = 9) {
split(x, ceiling(seq_along(x) / page_size))
}
plot_all_gears_multipanel <- function(combo_names, base_dir, years, output_dir) {
out_dir <- file.path(base_dir, output_dir)
if (!dir.exists(out_dir)) {
dir.create(out_dir, recursive = TRUE)
}
sim_long <- extract_all_fleet_sims(combo_names, base_dir, years)
obs_long <- read_fleet_obs(base_dir, years)
gears <- sort(unique(sim_long$Gear))
gear_pages <- split_into_pages(gears, page_size = 9)
for (i in seq_along(gear_pages)) {
plot_multi_gear_all_combos(
sim_long   = sim_long,
obs_long   = obs_long,
gears_subset = gear_pages[[i]],
out_dir    = out_dir,
page_id    = i
)
}
}
idx = 1
if (!IN_BEMTOOL) {
ALADYM_home <<- getwd()
years <<- c(2016)
years_forecast <<- c(2017)
FLEETSEGMENTS_names <<- NULL
all_years <<- years
INTEGRATED_APPROACH <<- FALSE
SAtool <<- "NONE"
BMT_SCENARIO <<- 0
BMT_HR_CHANGE_FISHMORTALITY <<- 3
GLO <- new.env()
GLO$L_number <- 12
BMT_SPECIES <<- c("")
ALADYM_spe <<- 1
} else {
SKIP_spe <<- FALSE
years_forecast <<- years.forecast
# years <<- years
}
showCompTime <<- F
# if (printOK) cat("\n\n")
print("***************************************************************************", quote=FALSE)
print("Loading ALADYM GUI (Graphical User Interface)...", quote=FALSE)
print("***************************************************************************", quote=FALSE)
cat("\n\n")
print(".......................................... [rungui.r]", quote=F)
suppressWarnings(source(paste(ALADYM_home, "/src/load_functions.r", sep=""))  )
suppressWarnings(source(paste(ALADYM_home, "/gui/scripts.r", sep="") ) )
suppressWarnings(source(paste(ALADYM_home, "/gui/ini.r", sep="")) )
suppressWarnings(source(paste(ALADYM_home, "/src/paths.r", sep=""))  )
# initialization matrices
Tr <<- 0
if (!IN_BEMTOOL) {
biological.lifeSpanM <<- 1
biological.lifeSpanF <<- 1
} else {
biological.lifeSpanM <<-  as.numeric(as.character(Populations[[ALADYM_spe]]@lifespan$lifespan[[1]]))
biological.lifeSpanF <<- convert_numeric0_to_na(as.numeric(as.character(convert_numeric0_to_na(Populations[[ALADYM_spe]]@lifespan$lifespan[[2]]))))
biological.lifeSpan <<- max(biological.lifeSpanM, biological.lifeSpanF)
}
months_vec_M <<- c(Tr:(biological.lifeSpanM*12))
months_vec_F <<- c(Tr:(biological.lifeSpanF*12))
biological.months_MM <<- length(months_vec_M)
biological.months_MF <<- length(months_vec_F)
main_window <<- gtkWindow(show=FALSE)
if (!IN_BEMTOOL) {
main_window["title"] <- AAA_VERSION_NAME
} else {
if (phase == "SIMULATION") {
main_window["title"] <- paste("BEMTOOL 2.0 biological simulation - " ,AAA_VERSION_NAME, " [",BMT_SPECIES[ALADYM_spe],"]", sep="" )
} else {
main_window["title"] <- paste("BEMTOOL 2.0 biological forecast - " ,AAA_VERSION_NAME, " [",BMT_SPECIES[ALADYM_spe],"]", sep="")
}
}
main_window$setDefaultSize(1024, 768)
gtkWindowSetResizable(main_window, FALSE)
#gtkWindowSetPosition(main_window, GTK_WIN_POS_CENTER_ALWAYS)
# define TAB
notebook <<- gtkNotebook()
notebook$setTabPos("top")
#
#  ALADYM in BEMTOOL
#
if (IN_BEMTOOL) {
if (phase=="SIMULATION") {
all_years <<- years
suppressWarnings(source(paste(ALADYM_home, "/gui/generaldata.r", sep="") ))
notebook$appendPage(vboxGeneralData, gtkLabel(str=" GENERAL DATA "))
suppressWarnings(source(paste(ALADYM_home, "/gui/biological.r", sep="") )	)
notebook$appendPage(vboxBiological, gtkLabel(str=" BIOLOGICAL "))
suppressWarnings(source(paste(ALADYM_home, "/gui/recruitment.r", sep="") ) )
notebook$appendPage(vboxRecruitment, gtkLabel(str=" RECRUITMENT "))
suppressWarnings(source(paste(ALADYM_home, "/gui/mortality.r", sep="") ) )
notebook$appendPage(vboxMortality, gtkLabel(str=" MORTALITY "))
# ********************************* FISHERY graphical elements
suppressWarnings(source(paste(ALADYM_home, "/gui/fishery.r", sep="") ) )
notebook$appendPage(vboxFishery, gtkLabel(str=" FISHERY "))
suppressWarnings( source(paste(ALADYM_home, "/gui/forecast.r", sep="") )	)
}
if (phase=="FORECAST") {
Tr <<- INP$tr
path_to_save <- paste(casestudy_path, "/Diagnosis/working files/GUIfle_fore.Rdata", sep="")
load(path_to_save)
FleetList_forecast <<- .GlobalEnv$ALADYM_GUI_fleets_fore[[ALADYM_spe]]
#print(paste("prima di chiamare ALADYM.r carico anno 1 specie", ALADYM_spe))
#print(FleetList_forecast[[1]]@fishingeffort.vector)
##gtkNotebookRemovePage(notebook, gtkNotebookPageNum(notebook, vboxFishery))
#gtkComboBoxSetActive(combo_fleetsegments_fore, -1 )
#gtkComboBoxSetActive(combo_fleetsegments_fore, 0 )
all_years <<- c(years, years_forecast)
# ********************************* FISHERY graphical elements
suppressWarnings(source(paste(ALADYM_home, "/gui/fishery.r", sep="") ))
notebook$appendPage(vboxFishery, gtkLabel(str=" SIMULATION "))
# ********************************* FORECAST graphical elements
suppressWarnings( source(paste(ALADYM_home, "/gui/forecast.r", sep="") )	)
#  for (item in BMT_FLEETSEGMENTS[associated_fleetsegment_indices]) {
#  combo_fleetsegments_fore$appendText(item)
#    }
gtkComboBoxSetActive(combo_fleetsegments, 0 )
# loadFleetsegmentintoGUI(FleetList_simulation[[1]])
#gtkEntrySetEditable(entryGearName, FALSE)
#  gtkComboBoxSetActive(combo_fleetsegments_fore, 0 )
notebook$appendPage(vboxForecast, gtkLabel(str=" FORECAST "))
}
# ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
# ???????????????????????????????????????????????????????????????????????????????????????????????????????? ALADYM STAND-ALONE
# ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
} else {
suppressWarnings(source(paste(ALADYM_home, "/gui/generaldata.r", sep="") ))
notebook$appendPage(vboxGeneralData, gtkLabel(str=" GENERAL DATA "))
suppressWarnings(source(paste(ALADYM_home, "/gui/biological.r", sep="") )	)
notebook$appendPage(vboxBiological, gtkLabel(str=" BIOLOGICAL "))
suppressWarnings(source(paste(ALADYM_home, "/gui/recruitment.r", sep="") ) )
notebook$appendPage(vboxRecruitment, gtkLabel(str=" RECRUITMENT "))
suppressWarnings(source(paste(ALADYM_home, "/gui/mortality.r", sep="") ) )
notebook$appendPage(vboxMortality, gtkLabel(str=" MORTALITY "))
# ********************************* FISHERY graphical elements
suppressWarnings(source(paste(ALADYM_home, "/gui/fishery.r", sep="") ) )
notebook$appendPage(vboxFishery, gtkLabel(str=" FISHERY "))
suppressWarnings(source(paste(ALADYM_home, "/gui/forecast.r", sep="") )	)
notebook$appendPage(vboxForecast, gtkLabel(str=" FORECAST "))
}
main_window$show()
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
activate_main_w()
# spe <- 'DPS'
spe_folder <- 'DPS17181920'
sel_file <- "Selectivity_DPS17181920_SEL.csv"
folder <- "C:/INPUT/ALADYM"
# selectivity parameters
p1 <- c(10, 15, 20) #seq(15, 20)
p2 <- c(5, 6) #seq(3, 7)
p3 <- c(7, 8)
params_sel <- list(p1, p2, p3)
selectivity_id <- hash()
selectivity_id[["1"]] <- list(c("param1", "param2"), c(1, 2))
selectivity_id[["4"]] <- list(c("param1", "param2", "param3"), c(1, 2, 3))
sel <- read.csv(paste(folder, "/", spe_folder, '/', sel_file, sep = ''),
sep = ';',
header = TRUE)
library(hash)
selectivity_id <- hash()
selectivity_id[["1"]] <- list(c("param1", "param2"), c(1, 2))
selectivity_id[["4"]] <- list(c("param1", "param2", "param3"), c(1, 2, 3))
sel <- read.csv(paste(folder, "/", spe_folder, '/', sel_file, sep = ''),
sep = ';',
header = TRUE)
sel[is.na(sel)] = ""
split_gear <- function(df, name_gear){
return(df[df$fleet_segment == name_gear, ])
}
df_by_gears <- list()
for (names in unique(sel$fleet_segment)) {
df_by_gears <- append(df_by_gears, list(split_gear(sel, names)))
}
df_by_gears
create_combo <- function(df){
sel_type             <- paste(df$sel_type[1])
names                <- df$fleet_segment[1]
param_names          <- selectivity_id[[sel_type]][[1]]
id                   <- selectivity_id[[sel_type]][[2]]
params               <- params_sel[id]
combo_grid           <- expand.grid(params)
colnames(combo_grid) <- param_names
return(list(combo_grid, names))
}
create_combo(df_by_gears[[1]])
df = df_by_gears[[1]]
paste(df$sel_type[1])
df$sel_type[1]
df$sel_type
selectivity_id[[sel_type]]
sel_type             <- paste(df$sel_type[1])
selectivity_id[[sel_type]]
selectivity_id[[sel_type]][[2]]
selectivity_id[[sel_type]][[1]]
param_names          <- selectivity_id[[sel_type]][[1]]
id                   <- selectivity_id[[sel_type]][[2]]
params_sel[id]
params_sel
params_sel[id]
p11 <- c(10, 15, 20) #seq(15, 20)
p12 <- c(5, 6) #seq(3, 7)
# sel 4
p41 <- c(12, 25)
p42 <- c(6, 7)
p43 <- c(7, 8)
# per-selectivity-type parameters
params_sel <- hash()
params_sel[["1"]] <- list(p11, p12)
params_sel[['4']] <- list(p41, p42, p43)
params_sel[[sel_type]]
params               <- params_sel[[sel_type]] #[id]
combo_grid           <- expand.grid(params)
combo_grid
colnames(combo_grid) <- param_names
combo_grid
# selectivity map
selectivity_id <- hash()
selectivity_id[["1"]] <- list(c("param1", "param2")) #, c(1, 2))
selectivity_id[["4"]] <- list(c("param1", "param2", "param3")) #, c(1, 2, 3))
param_names          <- selectivity_id[[sel_type]][[1]]
param_names
# id                   <- selectivity_id[[sel_type]][[2]]
params               <- params_sel[[sel_type]]
combo_grid           <- expand.grid(params)
colnames(combo_grid) <- param_names
combo_grid
sel_type = "4"
param_names          <- selectivity_id[[sel_type]][[1]]
# id                   <- selectivity_id[[sel_type]][[2]]
params               <- params_sel[[sel_type]]
combo_grid           <- expand.grid(params)
colnames(combo_grid) <- param_names
combo_grid
source("C:/Users/Nazareno Campioni/Desktop/ALADYM_tuning_selectivity_main_script.R", echo = TRUE)
library(hash)
source("C:/Users/Nazareno Campioni/Desktop/ALADYM_tuning_selectivity_main_script.R", echo = TRUE)
source("C:/Users/Nazareno Campioni/Desktop/ALADYM_tuning_selectivity_main_script.R", echo = TRUE)
source("C:/Users/Nazareno Campioni/Desktop/ALADYM_tuning_selectivity_main_script.R", echo = TRUE)
selectivity_id
selectivity_id[[as.character(sel_type)]][[1]]
length(selectivity_id[[as.character(sel_type)]][[1]])
seq_along(length(selectivity_id[[as.character(sel_type)]][[1]]))
source("C:/Users/Nazareno Campioni/Desktop/ALADYM_tuning_selectivity_main_script.R", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
traceback()
file.path(dir_to_create, "total_catch_sim.csv")
file.path(getwd(), results_folder, CAL$combo_tag)
file.path(getwd(), "list_of_combos")
results_folder
file.path(getwd(), results_folder, CAL$combo_tag)
results_folder <- file.path(getwd(), "list_of_combos")
file.path(getwd(), results_folder, CAL$combo_tag)
file.path(results_folder, CAL$combo_tag)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
Q
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/Desktop/ALADYM_tuning_selectivity_main_script.R", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
CONFIGURATION_file
list_dirs
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
list.dirs("C:/INPUT/ALADYM")
list_dirs[grepl("selectivity_configs", tolower(list_dirs))]
list_dirs[grepl("ALADYM/selectivity_configs", tolower(list_dirs))]
# list of config files
list_dirs <- list.dirs("C:/INPUT/ALADYM")
list_dirs <- list_dirs[grepl("ALADYM/selectivity_configs", tolower(list_dirs))]
list_dirs
list.dirs("C:/INPUT/ALADYM")
# list of config files
list_dirs <- list.dirs("C:/INPUT/ALADYM")
tolower(list_dirs)
# list of config files
list_dirs <- list.dirs("C:/INPUT/ALADYM")
list_dirs <- list_dirs[grepl("aladym/selectivity_configs", tolower(list_dirs))]
list_dirs
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
source("C:/Users/Nazareno Campioni/ALADYM-ver.Tuning-Selectivity/ALADYM_tuning_sel.r", echo = TRUE)
